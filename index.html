import React, { useState, useEffect } from 'react';
import { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';
import { Activity, Phone, AlertTriangle, TrendingUp, Globe, Signal } from 'lucide-react';

const SIPMonitorDashboard = () => {
  const [callData, setCallData] = useState([]);
  const [metrics, setMetrics] = useState({
    activeCalls: 0,
    avgMOS: 0,
    avgLatency: 0,
    callSuccess: 0,
    totalCalls: 0,
    failedCalls: 0
  });
  const [alerts, setAlerts] = useState([]);
  const [regionData, setRegionData] = useState([]);
  const [qualityData, setQualityData] = useState([]);

  // Simulate real-time data updates
  useEffect(() => {
    const interval = setInterval(() => {
      generateRealtimeData();
    }, 2000);

    return () => clearInterval(interval);
  }, []);

  const generateRealtimeData = () => {
    const timestamp = new Date().toLocaleTimeString();
    
    // Generate random but realistic SIP metrics
    const newMetrics = {
      activeCalls: Math.floor(Math.random() * 500) + 100,
      avgMOS: (Math.random() * 1.5 + 3.5).toFixed(2),
      avgLatency: Math.floor(Math.random() * 80) + 20,
      callSuccess: (Math.random() * 5 + 94).toFixed(1),
      totalCalls: Math.floor(Math.random() * 10000) + 50000,
      failedCalls: Math.floor(Math.random() * 100) + 50
    };

    setMetrics(newMetrics);

    // Update call quality chart
    setCallData(prev => {
      const newData = [...prev, {
        time: timestamp,
        mos: parseFloat(newMetrics.avgMOS),
        latency: newMetrics.avgLatency,
        jitter: Math.floor(Math.random() * 15) + 5,
        packetLoss: (Math.random() * 2).toFixed(2)
      }];
      return newData.slice(-15); // Keep last 15 data points
    });

    // Update region data
    const regions = ['US-East', 'US-West', 'EU-West', 'APAC', 'SA-East'];
    setRegionData(regions.map(region => ({
      name: region,
      calls: Math.floor(Math.random() * 200) + 50,
      quality: (Math.random() * 1 + 3.5).toFixed(1)
    })));

    // Update quality distribution
    setQualityData([
      { name: 'Excellent (4.5+)', value: Math.floor(Math.random() * 30) + 50, color: '#10b981' },
      { name: 'Good (4.0-4.5)', value: Math.floor(Math.random() * 20) + 25, color: '#3b82f6' },
      { name: 'Fair (3.5-4.0)', value: Math.floor(Math.random() * 10) + 15, color: '#f59e0b' },
      { name: 'Poor (<3.5)', value: Math.floor(Math.random() * 5) + 5, color: '#ef4444' }
    ]);

    // Generate alerts based on thresholds
    if (parseFloat(newMetrics.avgMOS) < 3.8) {
      addAlert('warning', 'Low MOS Score', `Current MOS: ${newMetrics.avgMOS}`);
    }
    if (newMetrics.avgLatency > 150) {
      addAlert('error', 'High Latency', `Latency: ${newMetrics.avgLatency}ms`);
    }
    if (parseFloat(newMetrics.callSuccess) < 95) {
      addAlert('warning', 'Call Success Rate Drop', `Success: ${newMetrics.callSuccess}%`);
    }
  };

  const addAlert = (type, title, message) => {
    const newAlert = {
      id: Date.now(),
      type,
      title,
      message,
      time: new Date().toLocaleTimeString()
    };
    
    setAlerts(prev => {
      const updated = [newAlert, ...prev].slice(0, 5);
      return updated;
    });
  };

  const MetricCard = ({ icon: Icon, title, value, suffix, trend, color }) => (
    <div className="bg-gray-800 rounded-lg p-6 border border-gray-700 hover:border-blue-500 transition-all">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <div className="flex items-center gap-2 text-gray-400 text-sm mb-2">
            <Icon size={16} />
            <span>{title}</span>
          </div>
          <div className="text-3xl font-bold text-white mb-1">
            {value}{suffix}
          </div>
          {trend && (
            <div className={`text-sm ${trend > 0 ? 'text-green-400' : 'text-red-400'}`}>
              {trend > 0 ? '↑' : '↓'} {Math.abs(trend)}%
            </div>
          )}
        </div>
        <div className={`p-3 rounded-lg ${color}`}>
          <Icon size={24} className="text-white" />
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-gray-900 text-white p-6">
      <div className="max-w-7xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
            Real-Time SIP Traffic Monitor
          </h1>
          <p className="text-gray-400">Live monitoring of SIP trunk quality and call metrics across global regions</p>
        </div>

        {/* Metric Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <MetricCard
            icon={Phone}
            title="Active Calls"
            value={metrics.activeCalls}
            suffix=""
            color="bg-blue-500"
          />
          <MetricCard
            icon={Signal}
            title="Avg MOS Score"
            value={metrics.avgMOS}
            suffix="/5.0"
            color="bg-green-500"
          />
          <MetricCard
            icon={Activity}
            title="Avg Latency"
            value={metrics.avgLatency}
            suffix="ms"
            color="bg-purple-500"
          />
          <MetricCard
            icon={TrendingUp}
            title="Call Success"
            value={metrics.callSuccess}
            suffix="%"
            color="bg-emerald-500"
          />
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          {/* Real-time Quality Metrics */}
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Activity size={20} className="text-blue-400" />
              Call Quality Metrics (Live)
            </h2>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={callData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis dataKey="time" stroke="#9ca3af" />
                <YAxis stroke="#9ca3af" />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Legend />
                <Line type="monotone" dataKey="mos" stroke="#10b981" name="MOS Score" strokeWidth={2} />
                <Line type="monotone" dataKey="latency" stroke="#3b82f6" name="Latency (ms)" strokeWidth={2} />
                <Line type="monotone" dataKey="jitter" stroke="#f59e0b" name="Jitter (ms)" strokeWidth={2} />
              </LineChart>
            </ResponsiveContainer>
          </div>

          {/* Quality Distribution */}
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <TrendingUp size={20} className="text-green-400" />
              Call Quality Distribution
            </h2>
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={qualityData}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({ name, percent }) => `${name}: ${(percent * 100).toFixed(0)}%`}
                  outerRadius={100}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {qualityData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* Regional Traffic and Alerts */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Regional Traffic */}
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Globe size={20} className="text-purple-400" />
              Regional Call Traffic
            </h2>
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={regionData}>
                <CartesianGrid strokeDasharray="3 3" stroke="#374151" />
                <XAxis dataKey="name" stroke="#9ca3af" />
                <YAxis stroke="#9ca3af" />
                <Tooltip 
                  contentStyle={{ backgroundColor: '#1f2937', border: '1px solid #374151' }}
                  labelStyle={{ color: '#fff' }}
                />
                <Legend />
                <Bar dataKey="calls" fill="#3b82f6" name="Active Calls" />
              </BarChart>
            </ResponsiveContainer>
          </div>

          {/* Alerts Panel */}
          <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <AlertTriangle size={20} className="text-yellow-400" />
              Recent Alerts
            </h2>
            <div className="space-y-3 max-h-[300px] overflow-y-auto">
              {alerts.length === 0 ? (
                <div className="text-gray-500 text-center py-8">
                  No alerts - All systems operational
                </div>
              ) : (
                alerts.map(alert => (
                  <div
                    key={alert.id}
                    className={`p-4 rounded-lg border-l-4 ${
                      alert.type === 'error'
                        ? 'bg-red-900/20 border-red-500'
                        : 'bg-yellow-900/20 border-yellow-500'
                    }`}
                  >
                    <div className="flex justify-between items-start mb-1">
                      <span className="font-semibold">{alert.title}</span>
                      <span className="text-xs text-gray-400">{alert.time}</span>
                    </div>
                    <p className="text-sm text-gray-300">{alert.message}</p>
                  </div>
                ))
              )}
            </div>
          </div>
        </div>

        {/* Stats Summary */}
        <div className="mt-8 bg-gray-800 rounded-lg p-6 border border-gray-700">
          <h2 className="text-xl font-semibold mb-4">System Statistics</h2>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div>
              <div className="text-gray-400 text-sm mb-1">Total Calls Today</div>
              <div className="text-2xl font-bold">{metrics.totalCalls.toLocaleString()}</div>
            </div>
            <div>
              <div className="text-gray-400 text-sm mb-1">Failed Calls</div>
              <div className="text-2xl font-bold text-red-400">{metrics.failedCalls}</div>
            </div>
            <div>
              <div className="text-gray-400 text-sm mb-1">Success Rate</div>
              <div className="text-2xl font-bold text-green-400">{metrics.callSuccess}%</div>
            </div>
            <div>
              <div className="text-gray-400 text-sm mb-1">Monitored Carriers</div>
              <div className="text-2xl font-bold">12</div>
            </div>
          </div>
        </div>

        {/* Footer Info */}
        <div className="mt-8 text-center text-gray-500 text-sm">
          <p>Dashboard updates every 2 seconds | Monitoring 5 regions | 12 carrier connections</p>
        </div>
      </div>
    </div>
  );
};

export default SIPMonitorDashboard;
